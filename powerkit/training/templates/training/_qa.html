{% load wagtailcore_tags %}
{% load staticfiles %}

<div id="app">
  <vue-snotify></vue-snotify>
  <div v-if="!lessonCompleted">
    <div class="exam__questionWrap">
      <!--div class="notification notification-success" v-if="isCorrect" v-text="message"></div-->
      <!--div class="notification notification-failure" v-if="!isCorrect && isCorrect !== null" v-text="message"></div-->
      
      <transition name="fade" mode="out-in">
        <div v-if="!qtn" class="h1__preHeading" key="1">Hang on...</div>
        <div v-else class="h1__preHeading" v-text="qtn.title" key="2"></div>
      </transition>
      <div class="exam__questionWrap__question">
        <transition name="fade" mode="out-in">
          <div v-if="!qtn" key="1"><p>Let me see...</p></div>
          <div v-else v-html="qtn.text" key="2"></div>
        </transition>
      </div>

     
          <transition name="fade" mode="out-in">
          <div v-if="!qtn" key="1">Hmmmm</div>
      <fieldset v-else key="2" class="exam__questionWrap__options">
        <label v-for="answer in answers" class="exam__questionWrap__options__option">
            <input type="radio" :value="answer.id" name="qtn.id" v-model="selected">
            <span v-text="answer.text"></span>
        </label>
      </fieldset>
          </transition>
    </div>

    <nav class="sessionNav" v-bind:class="loadingClass">
      <div class="sessionNav__controls">
          <div v-if="!completed" class="sessionNav__controls__button sessionNav__controls__button--next">
            <a v-if="selected === null" disabled>Pick an Answer</a>
            <a v-if="selected && !isChecking" @click.preventDefault="pickAnswer()">Final Answer</a>
            <a v-if="selected && isChecking" disabled>Hang on...</a>
          </div>
          <div v-else class="sessionNav__controls__button sessionNav__controls__button--next">
            <a @click.preventDefault="getQuestion()">Next</a>
          </div>
      </div>
    </nav>
  </div>
  <!-- Show results when module is completed -->
  <div v-else class="exam__questionWrap">
    <div class="exam__questionWrap__question">
      <h3>Completed!</h3>
      <h3>Your results are: <span v-text="resultCorrect"></span>/<span v-text="resultTotal"></span></h3>
      <a v-if="!isLoading" @click="nextLesson()">Next Lesson</a>
      <a v-else="isLoading">Hang on...</a>
    </div>
  </div>
</div>


{% block css %}
    <link href="{% static 'vendor/snotify/css/material.css' %}" rel="stylesheet" />
    <style>
      .fade-enter-active, .fade-leave-active {
        transition: opacity .5s;
      }
      .fade-enter, .fade-leave-to /* .fade-leave-active below version 2.1.8 */ {
        opacity: 0;
        /*transform: translateX(10px);*/
      }
      .exam__questionWrap {
        min-height: 400px;
      }
    </style>
{% endblock css %}

{% block js %}
<script src="{% static 'js/vue.js' %}"></script>
<script src="{% static 'js/vue-snotify.js' %}"></script>
<script src="https://unpkg.com/vue-resource@1.3.1/dist/vue-resource.min.js"></script>
<script>

  var vm = new Vue({
      el: '#app',
      delimiters: ["[","]"],
      data: {
        pageId: {{page.id}},
        questionId: {{question_id}},
        qtn: null,
        answers: [],
        selected: null,
        isChecking: false,
        isCorrect: null,
        completed: false,
        isLoading: false,
        resultCorrect: null,
        resultTotal: null,
        lessonCompleted: false,
        show: false
      },
      mounted() {
        //console.log('vue ready');
        //console.log('question is ');
        this.getQuestion();
      },
      methods: {
        getQuestion: function() {
          this.isLoading = true;
          this.qtn = null;
          this.answers = [];
          const url = "/training/question/";
          this.$http.get(url).then(response => {
            console.log(response);
            //this.setNewQuestion(response.body);
            setTimeout(() => this.setNewQuestion(response.body), 1500);
            
          })
        },
        setNewQuestion: function(data) {
          const isCompleted = data.lessonCompleted;
          if (isCompleted) {
            this.lessonCompleted = true;
            this.resultTotal = data.total;
            this.resultCorrect = data.correct;
          } else {
            this.qtn = data.question;
            this.answers = data.answers;
            this.completed = false;
            this.isCorrect = null;
            this.isChecking = false;
            this.selected = null;
          }
          this.isLoading = false;
        },
        pickAnswer: function() {
          console.log(this.selected);
          this.isChecking = true;
          const url = `/training/select_answer/${this.selected}/`;
          console.log(url);
          this.$http.get(url).then(response => {
            console.log(response);
            this.isChecking = false;
            this.isCorrect = response.body.correct;
            this.completed = true;
            if (this.isCorrect === true) {
              vm.$snotify.success('Your answer is Correct!', 'Success', {
                position: 'centerCenter',
                timeout: 1500
              });
              this.getQuestion();
              //setTimeout(function() {this.getQuestion()}.bind(this), 1500);
            } else if (this.isCorrect === false) {
              vm.$snotify.error('Sorry, your answer is wrong!', 'Error', {
                position: 'centerCenter',
                timeout: 1500
              });
            }
          })
        },
        nextLesson: function() {
          //this.isLoading = true;
          const url = `/training/complete/${this.pageId}/?async=1`;
          this.$http.get(url).then(response => {
              console.log(response.body);
              window.location = response.body.redirect_url;
          })
        },
        animate: function() {
          console.log('animating')
          let old_qtn = this.qtn;
          this.qtn = null

          this.qtn = old_qtn;
        }
      },
      computed: {
        message: function() {
          if (this.isCorrect === true) {
            return "Your answer is Correct";
          } else if (this.isCorrect === false) {
            return "Your answer is Wrong";
          } else {
            return "";
          }
        },
        loadingClass: function() {
          return {
            'sessionNav--loading': this.isLoading
          }
        }
      }
    })

  
</script>
{% endblock js %}