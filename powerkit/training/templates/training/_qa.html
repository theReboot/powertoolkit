{% load wagtailcore_tags %}
{% load staticfiles %}

<div id="app">
  <div v-if="!lessonCompleted">
    <div class="exam__questionWrap">
      <div class="notification notification-success" v-if="isCorrect" v-text="message"></div>
      <div class="notification notification-failure" v-if="!isCorrect && isCorrect !== null" v-text="message"></div>
      <div v-if="qtn" class="h1__preHeading" v-text="qtn.title"></div>
      <div class="exam__questionWrap__question">
        <div v-if="qtn" v-html="qtn.text"></div>
      </div>
      <fieldset class="exam__questionWrap__options">
        <label v-for="answer in answers" class="exam__questionWrap__options__option">
          <input type="radio" :value="answer.id" name="qtn.id" v-model="selected">
          <span v-text="answer.text"></span>
        </label>
      </fieldset>
    </div>


    <nav class="sessionNav">
      <div class="sessionNav__controls">
          <div v-if="!completed" class="sessionNav__controls__button sessionNav__controls__button--next">
            <button v-if="selected === null" class="button" disabled>Pick an Answer</button>
            <a v-if="selected && !isChecking" @click.preventDefault="pickAnswer()">Final Answer</a>
            <button v-if="selected && isChecking" class="button" disabled>Hang on...</button>
          </div>
          <div v-else class="sessionNav__controls__button sessionNav__controls__button--next">
            <a class="button" @click.preventDefault="getQuestion()">Next</a>
          </div>
      </div>
    </nav>
  </div>
  <!-- Show results when module is completed -->
  <div v-else class="exam__questionWrap">
    <div class="exam__questionWrap__question">
      <h3>Completed!</h3>
      <h3>Your results are: <span v-text="resultCorrect"></span>/<span v-text="resultTotal"></span></h3>
      <a v-if="!isLoading" @click="nextLesson()">Next Lesson</a>
      <a v-else="isLoading">Hang on...</a>
    </div>
  </div>
</div>

{% block css %}
    <link href="{% static 'vendor/snotify/css/material.css' %}" rel="stylesheet" />
{% endblock css %}

{% block js %}
<script src="{% static 'js/vue.js' %}"></script>
<script src="{% static 'js/vue-snotify.js' %}"></script>
<script src="https://unpkg.com/vue-resource@1.3.1/dist/vue-resource.min.js"></script>
<script>

  var vm = new Vue({
      el: '#app',
      delimiters: ["[","]"],
      data: {
        pageId: {{page.id}},
        questionId: {{question_id}},
        qtn: null,
        answers: [],
        selected: null,
        isChecking: false,
        isCorrect: null,
        completed: false,
        isLoading: false,
        resultCorrect: null,
        resultTotal: null,
        lessonCompleted: false
      },
      mounted() {
        console.log('vue ready');
        console.log('question is ');
        this.getQuestion();
      },
      methods: {
        getQuestion: function() {
          const url = "/training/question/";
          this.$http.get(url).then(response => {
            console.log(response);
            const isCompleted = response.body.lessonCompleted;
            
            if (isCompleted) {
              this.lessonCompleted = true;
              this.resultTotal = response.body.total;
              this.resultCorrect = response.body.correct;
            } else {
              this.qtn = response.body.question;
              this.answers = response.body.answers;
              this.completed = false;
              this.isCorrect = null;
              this.isChecking = false;
              this.selected = null;
            }
          })
        },
        pickAnswer: function() {
          console.log(this.selected);
          this.isChecking = true;
          const url = `/training/select_answer/${this.selected}/`;
          console.log(url);
          this.$http.get(url).then(response => {
            console.log(response);
            this.isChecking = false;
            this.isCorrect = response.body.correct;
            this.completed = true;
            if (this.isCorrect === true) {
              setTimeout(function() {this.getQuestion()}.bind(this), 1500);
            }
          })
        },
        nextLesson: function() {
          this.isLoading = true;
          const url = `/training/complete/${this.pageId}/?async=1`;
          this.$http.get(url).then(response => {
              console.log(response.body);
              window.location = response.body.redirect_url;
          })
        }
      },
      computed: {
        message: function() {
          if (this.isCorrect === true) {
            return "Your answer is Correct";
          } else if (this.isCorrect === false) {
            return "Your answer is Wrong";
          } else {
            return "";
          }
        }
      }
    })

  
</script>
{% endblock js %}